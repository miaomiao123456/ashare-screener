<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Aè‚¡ä¼˜è´¨è‚¡ç¥¨ç­›é€‰å™¨</title>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
<style>
/* ===== CSS Variables ===== */
:root {
  --red: #e63946;
  --red-dark: #c1121f;
  --blue: #457b9d;
  --blue-dark: #1d3557;
  --green: #2a9d8f;
  --gold: #e9c46a;
  --bg: #f0f2f5;
  --card: #ffffff;
  --text: #1d3557;
  --text2: #6c757d;
  --radius: 12px;
  --shadow: 0 2px 12px rgba(0,0,0,0.08);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Microsoft YaHei', sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
}

/* ===== Header ===== */
.header {
  background: linear-gradient(135deg, var(--red) 0%, var(--blue-dark) 100%);
  color: #fff;
  padding: 1.5rem 1rem;
  text-align: center;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}
.header h1 { font-size: 1.4rem; font-weight: 700; letter-spacing: 1px; }
.header .sub { font-size: 0.8rem; opacity: 0.85; margin-top: 4px; }

/* ===== Main ===== */
.main { padding: 1rem; max-width: 1100px; margin: 0 auto; }

/* ===== Panel ===== */
.panel {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 1.25rem;
  margin-bottom: 1rem;
}
.panel-title {
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 2px solid var(--red);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

/* ===== Criteria List ===== */
.criteria-list {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  margin-bottom: 1.25rem;
}
.criterion-item {
  background: var(--bg);
  border-radius: 8px;
  border-left: 3px solid var(--green);
  overflow: hidden;
}
.criterion-header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.7rem 0.8rem;
  cursor: pointer;
  user-select: none;
  transition: background 0.15s;
}
.criterion-header:hover { background: #e4e7eb; }
/* checkbox */
.criterion-cb {
  width: 18px; height: 18px;
  accent-color: var(--red);
  cursor: pointer;
  flex-shrink: 0;
}
.criterion-item.disabled { opacity: 0.5; }
.criterion-item.disabled .criterion-header { cursor: default; }
.select-actions {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
}
.select-actions button {
  padding: 0.35rem 0.8rem;
  border: 1px solid #ddd;
  border-radius: 6px;
  background: #fff;
  font-size: 0.78rem;
  cursor: pointer;
  color: var(--text);
  transition: all 0.15s;
}
.select-actions button:hover { border-color: var(--red); color: var(--red); }
.criterion-header .num {
  width: 22px; height: 22px;
  background: var(--green);
  color: #fff;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.72rem;
  font-weight: 700;
  flex-shrink: 0;
}
.criterion-header .title {
  font-size: 0.88rem;
  font-weight: 600;
  flex: 1;
}
.criterion-header .arrow {
  font-size: 0.7rem;
  color: var(--text2);
  transition: transform 0.2s;
}
.criterion-item.open .arrow { transform: rotate(180deg); }
.criterion-detail {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
}
.criterion-item.open .criterion-detail { max-height: 600px; }
.criterion-detail-inner {
  padding: 0 0.8rem 0.8rem 2.8rem;
  font-size: 0.78rem;
  color: var(--text2);
  line-height: 1.7;
}
.criterion-detail-inner .logic-label {
  color: var(--blue-dark);
  font-weight: 600;
  font-size: 0.76rem;
  margin-top: 0.3rem;
  display: block;
}
.criterion-detail-inner .logic-formula {
  background: #fff;
  border: 1px solid #e0e0e0;
  border-radius: 6px;
  padding: 0.4rem 0.6rem;
  margin: 0.3rem 0;
  font-family: 'Menlo', 'Consolas', monospace;
  font-size: 0.74rem;
  color: var(--text);
  white-space: pre-wrap;
  word-break: break-all;
}
.criterion-detail-inner .note {
  color: var(--red);
  font-size: 0.74rem;
  margin-top: 0.2rem;
}

/* ===== Button ===== */
.btn {
  width: 100%;
  padding: 0.9rem;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-primary { background: var(--red); color: #fff; }
.btn-primary:hover { background: var(--red-dark); transform: translateY(-1px); }
.btn-primary:disabled { background: var(--text2); cursor: not-allowed; transform: none; }

/* ===== Progress ===== */
.progress-wrap { margin-top: 1rem; display: none; }
.progress-wrap.active { display: block; }
.progress-bar {
  height: 6px;
  background: #e0e0e0;
  border-radius: 3px;
  overflow: hidden;
}
.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--red), var(--blue));
  width: 0%;
  transition: width 0.4s ease;
  border-radius: 3px;
}
.progress-text { font-size: 0.82rem; color: var(--text2); margin-top: 0.4rem; }

/* ===== Results ===== */
.results { display: none; }
.results.active { display: block; }

.summary-row {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  margin-bottom: 1rem;
}
.stat-card {
  flex: 1;
  min-width: 80px;
  text-align: center;
  padding: 0.8rem;
  background: var(--bg);
  border-radius: 8px;
}
.stat-card .val { font-size: 1.6rem; font-weight: 700; color: var(--red); }
.stat-card .lbl { font-size: 0.75rem; color: var(--text2); }

/* ===== Stage List ===== */
.stages { margin-bottom: 1rem; }
.stage-row {
  display: flex;
  justify-content: space-between;
  padding: 0.4rem 0;
  border-bottom: 1px solid var(--bg);
  font-size: 0.85rem;
}
.stage-row .name { font-weight: 500; }
.stage-row .nums { color: var(--text2); }
.stage-row .nums .elim { color: var(--red); font-weight: 600; }

/* ===== Stock Grid ===== */
.stock-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 0.6rem;
}
.stock-card {
  padding: 0.8rem;
  background: var(--bg);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
  border: 2px solid transparent;
}
.stock-card:hover { border-color: var(--red); transform: translateY(-2px); box-shadow: var(--shadow); }
.stock-card:active { transform: scale(0.97); }
.stock-card .code { font-weight: 700; color: var(--red); font-size: 0.95rem; }
.stock-card .name { font-size: 0.82rem; color: var(--text2); margin-top: 2px; }

/* ===== Modal ===== */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 200;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}
.modal-overlay.active { display: flex; justify-content: center; align-items: flex-start; }
.modal {
  background: var(--card);
  width: 100%;
  max-width: 960px;
  margin: 1rem;
  border-radius: var(--radius);
  overflow: hidden;
  position: relative;
}
.modal-header {
  padding: 1rem 1.25rem;
  background: linear-gradient(135deg, var(--blue-dark), var(--blue));
  color: #fff;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.modal-header h2 { font-size: 1.15rem; }
.modal-header .price { font-size: 1.3rem; font-weight: 700; }
.modal-header .sector-tag {
  display: inline-block;
  background: rgba(255,255,255,0.2);
  padding: 2px 10px;
  border-radius: 12px;
  font-size: 0.75rem;
  margin-top: 4px;
}
.modal-close {
  background: rgba(255,255,255,0.2);
  border: none;
  color: #fff;
  width: 36px; height: 36px;
  border-radius: 50%;
  font-size: 1.2rem;
  cursor: pointer;
  flex-shrink: 0;
}

/* ===== Tabs ===== */
.tabs {
  display: flex;
  border-bottom: 2px solid var(--bg);
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
.tab-btn {
  flex: 1;
  padding: 0.75rem 0.5rem;
  background: none;
  border: none;
  font-size: 0.85rem;
  font-weight: 500;
  cursor: pointer;
  color: var(--text2);
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
  white-space: nowrap;
  transition: all 0.2s;
}
.tab-btn.active { color: var(--red); border-bottom-color: var(--red); }
.tab-pane { display: none; padding: 1rem; }
.tab-pane.active { display: block; }

/* ===== Chart ===== */
.chart-box { width: 100%; height: 420px; }

/* ===== Financial Tables ===== */
.fin-section { margin-bottom: 1.5rem; }
.fin-section h3 { font-size: 0.95rem; margin-bottom: 0.5rem; color: var(--blue-dark); }
.table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
.fin-table {
  width: 100%;
  min-width: 500px;
  border-collapse: collapse;
  font-size: 0.8rem;
}
.fin-table th, .fin-table td {
  padding: 0.5rem 0.6rem;
  text-align: right;
  border-bottom: 1px solid var(--bg);
}
.fin-table th {
  background: var(--bg);
  font-weight: 600;
  position: sticky;
  top: 0;
  z-index: 1;
}
.fin-table td:first-child, .fin-table th:first-child {
  text-align: left;
  position: sticky;
  left: 0;
  background: var(--card);
  font-weight: 500;
  z-index: 2;
}
.fin-table th:first-child { background: var(--bg); z-index: 3; }

/* growth charts in financials */
.growth-charts { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
.growth-chart-box { height: 260px; }

/* ===== Shareholder Table ===== */
.sh-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
.sh-table th, .sh-table td { padding: 0.5rem; border-bottom: 1px solid var(--bg); text-align: left; }
.sh-table th { background: var(--bg); font-weight: 600; }
.sh-soe { color: var(--red); font-weight: 600; }

/* ===== Dividend ===== */
.div-chart-box { height: 280px; margin-bottom: 1rem; }

/* ===== Loading ===== */
.loading {
  text-align: center;
  padding: 3rem 1rem;
  color: var(--text2);
}
.spinner {
  width: 32px; height: 32px;
  border: 3px solid var(--bg);
  border-top-color: var(--red);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: 0 auto 0.8rem;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ===== Footer ===== */
.footer {
  text-align: center;
  padding: 1rem;
  font-size: 0.75rem;
  color: var(--text2);
}

/* ===== Mobile ===== */
@media (max-width: 768px) {
  .header h1 { font-size: 1.2rem; }
  .criterion-detail-inner { padding-left: 2.2rem; }
  .stock-grid { grid-template-columns: repeat(2, 1fr); }
  .chart-box { height: 320px; }
  .modal { margin: 0; border-radius: var(--radius) var(--radius) 0 0; margin-top: auto; max-height: 92vh; overflow-y: auto; }
  .modal-overlay.active { align-items: flex-end; }
  .growth-charts { grid-template-columns: 1fr; }
  .growth-chart-box { height: 220px; }
}
@media (max-width: 480px) {
  .main { padding: 0.5rem; }
  .panel { padding: 1rem; }
  .criterion-detail-inner .logic-formula { font-size: 0.7rem; }
  .stat-card .val { font-size: 1.3rem; }
}
</style>
</head>
<body>

<header class="header">
  <h1>Aè‚¡ä¼˜è´¨è‚¡ç¥¨ç­›é€‰å™¨</h1>
  <div class="sub">8å¤§è´¢åŠ¡æŒ‡æ ‡ | ä»·å€¼æŠ•èµ„ç­›é€‰å·¥å…·</div>
</header>

<main class="main">
  <!-- ç­›é€‰é¢æ¿ -->
  <section class="panel">
    <div class="panel-title">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
      ç­›é€‰æ¡ä»¶
    </div>
    <div class="select-actions">
      <button onclick="selectAll(true)">å…¨é€‰</button>
      <button onclick="selectAll(false)">å…¨ä¸é€‰</button>
      <span style="font-size:0.78rem;color:var(--text2);line-height:2;">å‹¾é€‰éœ€è¦å¯ç”¨çš„ç­›é€‰æ¡ä»¶</span>
    </div>
    <div style="background: linear-gradient(135deg, #fff3cd, #ffeaa7); border-left: 4px solid #e9c46a; padding: 0.8rem 1rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.85rem;">
      <div style="font-weight: 600; color: #856404; margin-bottom: 0.3rem; display: flex; align-items: center; gap: 0.5rem;">
        <span style="font-size: 1.1rem;">âš ï¸</span>
        <span>ç­›é€‰é€»è¾‘è¯´æ˜</span>
      </div>
      <div style="color: #856404; line-height: 1.6;">
        æœ¬ç­›é€‰å™¨ä½¿ç”¨ <strong>AND é€»è¾‘(äº¤é›†)</strong>ï¼šåªæœ‰<strong>åŒæ—¶æ»¡è¶³æ‰€æœ‰é€‰ä¸­æ¡ä»¶</strong>çš„è‚¡ç¥¨æ‰ä¼šè¢«ç­›é€‰å‡ºæ¥ã€‚<br>
        ä¾‹å¦‚:å‹¾é€‰æ¡ä»¶1ã€2ã€3,åˆ™åªæœ‰<strong>åŒæ—¶é€šè¿‡</strong>è¿™ä¸‰ä¸ªæ¡ä»¶çš„è‚¡ç¥¨æ‰ä¼šå‡ºç°åœ¨ç»“æœä¸­ã€‚
      </div>
    </div>
    <div class="criteria-list" id="criteriaList">

      <div class="criterion-item" data-id="1">
        <div class="criterion-header">
          <input type="checkbox" class="criterion-cb" checked data-id="1" onclick="event.stopPropagation()">
          <span class="num">1</span>
          <span class="title" onclick="toggleCriterion(this.closest('.criterion-item'))">è¿ç»­3å¹´å¹´æŠ¥è¥æ”¶å‡€åˆ©å¢é•¿</span>
          <span class="arrow" onclick="toggleCriterion(this.closest('.criterion-item'))">&#9660;</span>
        </div>
        <div class="criterion-detail"><div class="criterion-detail-inner">
          <span class="logic-label">æ•°æ®æ¥æº</span>
          åˆ©æ¶¦è¡¨ï¼ˆå¹´æŠ¥ï¼ŒæŠ¥å‘ŠæœŸä»¥12æœˆ31æ—¥ç»“å°¾ï¼‰
          <span class="logic-label">æ—¶é—´çª—å£</span>
          è€ƒè™‘å¹´æŠ¥æŠ«éœ²å»¶è¿Ÿï¼š5æœˆä¹‹åå–ä¸Šä¸€å¹´å¹´æŠ¥ï¼Œ4æœˆåŠä¹‹å‰å–å‰ä¸¤å¹´å¹´æŠ¥ã€‚å…±å–æœ€è¿‘4å¹´å¹´æŠ¥ã€‚
          <span class="logic-label">åˆ¤æ–­å…¬å¼</span>
          <div class="logic-formula">Year1è¥æ”¶ > Year2è¥æ”¶ > Year3è¥æ”¶ > Year4è¥æ”¶
Year1å‡€åˆ© > Year2å‡€åˆ© > Year3å‡€åˆ© > Year4å‡€åˆ©
ä¸”æ¯å¹´åŸºæ•° > 0ï¼ˆæ’é™¤äºæŸè½¬ç›ˆåˆ©ï¼‰</div>
          <div class="note">* å¦‚å¹´æŠ¥æ•°æ®ä¸è¶³4å¹´æˆ–å¹´ä»½ä¸è¿ç»­ï¼Œè§†ä¸ºä¸é€šè¿‡</div>
        </div></div>
      </div>

      <div class="criterion-item" data-id="2">
        <div class="criterion-header">
          <input type="checkbox" class="criterion-cb" checked data-id="2" onclick="event.stopPropagation()">
          <span class="num">2</span>
          <span class="title" onclick="toggleCriterion(this.closest('.criterion-item'))">å­£æŠ¥è¥æ”¶å‡€åˆ©åŒæ¯”ç¯æ¯”å¢é•¿</span>
          <span class="arrow" onclick="toggleCriterion(this.closest('.criterion-item'))">&#9660;</span>
        </div>
        <div class="criterion-detail"><div class="criterion-detail-inner">
          <span class="logic-label">æ•°æ®æ¥æº</span>
          åˆ©æ¶¦è¡¨ï¼ˆæœ€è¿‘8ä¸ªå­£åº¦æŠ¥å‘Šï¼‰
          <span class="logic-label">åŒæ¯”é€»è¾‘</span>
          <div class="logic-formula">æœ¬å­£è¥æ”¶ > å»å¹´åŒå­£è¥æ”¶ï¼ˆå¦‚2024Q3 vs 2023Q3ï¼‰
æœ¬å­£å‡€åˆ© > å»å¹´åŒå­£å‡€åˆ©
å»å¹´åŒå­£åŸºæ•°å¿…é¡» > 0</div>
          <span class="logic-label">ç¯æ¯”é€»è¾‘</span>
          <div class="logic-formula">æœ¬å­£è¥æ”¶ > ä¸Šä¸€å­£è¥æ”¶ï¼ˆå¦‚Q3 vs Q2ï¼ŒQ1 vs ä¸Šå¹´Q4ï¼‰
æœ¬å­£å‡€åˆ© > ä¸Šä¸€å­£å‡€åˆ©
ä¸Šä¸€å­£åŸºæ•°å¿…é¡» > 0</div>
          <div class="note">* è¦æ±‚åŒæ¯”+ç¯æ¯”åŒæ—¶æ»¡è¶³ï¼Œè¥æ”¶å’Œå‡€åˆ©æ¶¦å››é¡¹å…¨éƒ¨æ­£å¢é•¿</div>
        </div></div>
      </div>

      <div class="criterion-item" data-id="3">
        <div class="criterion-header">
          <input type="checkbox" class="criterion-cb" checked data-id="3" onclick="event.stopPropagation()">
          <span class="num">3</span>
          <span class="title" onclick="toggleCriterion(this.closest('.criterion-item'))">è¿ç»­5å¹´ç°é‡‘åˆ†çº¢ï¼Œæ— å¢å‘å‘å€º</span>
          <span class="arrow" onclick="toggleCriterion(this.closest('.criterion-item'))">&#9660;</span>
        </div>
        <div class="criterion-detail"><div class="criterion-detail-inner">
          <span class="logic-label">åˆ†çº¢æ£€æŸ¥</span>
          <div class="logic-formula">æ£€æŸ¥è¿‡å»5ä¸ªå®Œæ•´è´¢å¹´çš„åˆ†çº¢è®°å½•ï¼ˆç”¨bonus_yearå­—æ®µï¼‰
æ¯å¹´éƒ½æœ‰ cash_before_tax > 0ï¼ˆæ¯è‚¡ç¨å‰ç°é‡‘åˆ†çº¢ï¼‰
è€ƒè™‘åˆ†çº¢æ¬¡å¹´å®æ–½çš„å»¶è¿Ÿï¼š
  7æœˆåæ£€æŸ¥ year-1 ~ year-5
  7æœˆå‰æ£€æŸ¥ year-2 ~ year-6</div>
          <span class="logic-label">å¢å‘æ£€æŸ¥</span>
          <div class="logic-formula">5å¹´å†…æ— å®šå‘å¢å‘ / å…¬å¼€å¢å‘è®°å½•
æŸ¥ STK_CAPITAL_CHANGE è¡¨ï¼Œchange_reason_id âˆˆ [303,304,305,306]</div>
          <span class="logic-label">å‘å€ºæ£€æŸ¥</span>
          <div class="logic-formula">5å¹´å†…æ— å¯è½¬å€ºå‘è¡Œè®°å½•
æŸ¥ CONBOND_BASIC_INFO è¡¨ï¼Œlist_date >= äº”å¹´å‰</div>
        </div></div>
      </div>

      <div class="criterion-item" data-id="4">
        <div class="criterion-header">
          <input type="checkbox" class="criterion-cb" checked data-id="4" onclick="event.stopPropagation()">
          <span class="num">4</span>
          <span class="title" onclick="toggleCriterion(this.closest('.criterion-item'))">è‚¡æ¯ç‡ > 4%</span>
          <span class="arrow" onclick="toggleCriterion(this.closest('.criterion-item'))">&#9660;</span>
        </div>
        <div class="criterion-detail"><div class="criterion-detail-inner">
          <span class="logic-label">è®¡ç®—å…¬å¼</span>
          <div class="logic-formula">è‚¡æ¯ç‡ = è¿‡å»12ä¸ªæœˆæ¯è‚¡ç°é‡‘åˆ†çº¢(ç¨å‰) / å½“å‰è‚¡ä»· Ã— 100%</div>
          <span class="logic-label">å–æ•°é€»è¾‘</span>
          <div class="logic-formula">å½“å‰è‚¡ä»· = æœ€æ–°æ”¶ç›˜ä»·
åˆ†çº¢ = è‚¡æƒç™»è®°æ—¥åœ¨è¿‡å»12ä¸ªæœˆå†…çš„æ‰€æœ‰åˆ†çº¢è®°å½•ä¹‹å’Œ
  ä½¿ç”¨ a_registration_date å­—æ®µé™å®šæ—¶é—´èŒƒå›´
  ä½¿ç”¨ cash_before_tax å­—æ®µï¼ˆæ¯è‚¡ç¨å‰æ´¾æ¯ï¼‰</div>
          <div class="note">* è¦æ±‚è‚¡æ¯ç‡ >= 4.0%ï¼Œè‚¡ä»·å’Œåˆ†çº¢ç¼ºå¤±åˆ™ä¸é€šè¿‡</div>
        </div></div>
      </div>

      <div class="criterion-item" data-id="5">
        <div class="criterion-header">
          <input type="checkbox" class="criterion-cb" checked data-id="5" onclick="event.stopPropagation()">
          <span class="num">5</span>
          <span class="title" onclick="toggleCriterion(this.closest('.criterion-item'))">å‰äºŒå¤§è‚¡ä¸œæ˜¯å¤®å›½ä¼</span>
          <span class="arrow" onclick="toggleCriterion(this.closest('.criterion-item'))">&#9660;</span>
        </div>
        <div class="criterion-detail"><div class="criterion-detail-inner">
          <span class="logic-label">æ•°æ®æ¥æº</span>
          åå¤§è‚¡ä¸œæ•°æ®ï¼ˆSTK_SHAREHOLDER_TOP10ï¼‰ï¼Œå–æœ€æ–°ä¸€æœŸæŠ¥å‘Š
          <span class="logic-label">åˆ¤æ–­é€»è¾‘</span>
          <div class="logic-formula">å–æœ€æ–°ä¸€æœŸ shareholder_rank = 1 å’Œ 2 çš„è‚¡ä¸œåç§°
ä¸¤è€…åç§°éƒ½åŒ…å«å¤®å›½ä¼å…³é”®è¯ â†’ é€šè¿‡</div>
          <span class="logic-label">å¤®å›½ä¼å…³é”®è¯</span>
          <div class="logic-formula">å›½æœ‰ã€å›½èµ„ã€è´¢æ”¿å±€/å…ã€å›½æŠ•ã€ä¸­å¤®ã€çœ/å¸‚äººæ°‘æ”¿åºœã€
è´¢æ”¿éƒ¨ã€å›½åŠ¡é™¢ã€ä¸­å¤®æ±‡é‡‘ã€ç¤¾ä¿åŸºé‡‘ã€SASACã€
å›½æœ‰ç‹¬èµ„ã€å›½æœ‰èµ„äº§ã€ç®¡ç†å§”å‘˜ä¼šã€
ä¸­å›½çŸ³æ²¹/çŸ³åŒ–/ç§»åŠ¨/ç”µä¿¡/è”é€š/å›½å®¶ç”µç½‘ ç­‰å¤®ä¼åç§°</div>
          <div class="note">* å‰ä¸€ç‰ˆåªæŸ¥å®æ§äººï¼Œå·²ä¿®æ­£ä¸ºæŸ¥åå¤§è‚¡ä¸œå‰ä¸¤ä½</div>
        </div></div>
      </div>

      <div class="criterion-item" data-id="6">
        <div class="criterion-header">
          <input type="checkbox" class="criterion-cb" checked data-id="6" onclick="event.stopPropagation()">
          <span class="num">6</span>
          <span class="title" onclick="toggleCriterion(this.closest('.criterion-item'))">å¤§è‚¡ä¸œä¸»åŠ¨å›è´­è‚¡ç¥¨</span>
          <span class="arrow" onclick="toggleCriterion(this.closest('.criterion-item'))">&#9660;</span>
        </div>
        <div class="criterion-detail"><div class="criterion-detail-inner">
          <span class="logic-label">æ•°æ®æ¥æº</span>
          è‚¡ç¥¨å›è´­æ•°æ®ï¼ˆSTK_SHARES_REPURCHASEï¼‰
          <span class="logic-label">åˆ¤æ–­é€»è¾‘</span>
          <div class="logic-formula">æ£€æŸ¥è¿‘2å¹´å†…æ˜¯å¦å­˜åœ¨å›è´­è®°å½•
å›è´­çŠ¶æ€(repurchase_state)ä¸ºä»¥ä¸‹ä¹‹ä¸€å³é€šè¿‡ï¼š
  å·²å®Œæˆ / å®æ–½ä¸­ / å·²å®æ–½ / è‘£äº‹ä¼šé¢„æ¡ˆ / è‚¡ä¸œå¤§ä¼šé€šè¿‡</div>
          <div class="note">* ä»…å·²å…¬å‘Šä½†æœªå®æ–½çš„ä¸è®¡å…¥</div>
        </div></div>
      </div>

      <div class="criterion-item" data-id="7">
        <div class="criterion-header">
          <input type="checkbox" class="criterion-cb" checked data-id="7" onclick="event.stopPropagation()">
          <span class="num">7</span>
          <span class="title" onclick="toggleCriterion(this.closest('.criterion-item'))">å®æ§äººæœªå˜æ›´</span>
          <span class="arrow" onclick="toggleCriterion(this.closest('.criterion-item'))">&#9660;</span>
        </div>
        <div class="criterion-detail"><div class="criterion-detail-inner">
          <span class="logic-label">æ•°æ®æ¥æº</span>
          å®é™…æ§åˆ¶äººä¿¡æ¯ï¼ˆSTK_CONTROLLER_INFOï¼‰
          <span class="logic-label">åˆ¤æ–­é€»è¾‘</span>
          <div class="logic-formula">è·å–è¿‘3å¹´æ‰€æœ‰å®é™…æ§åˆ¶äººè®°å½•
controller_name å»é‡åï¼š
  å”¯ä¸€å€¼ <= 1 â†’ é€šè¿‡ï¼ˆæœªå˜æ›´ï¼‰
  å”¯ä¸€å€¼ >  1 â†’ ä¸é€šè¿‡ï¼ˆå‘ç”Ÿå˜æ›´ï¼‰
  æ— è®°å½• â†’ è§†ä¸ºç¨³å®šï¼ˆé€šè¿‡ï¼‰</div>
        </div></div>
      </div>

      <div class="criterion-item" data-id="8">
        <div class="criterion-header">
          <input type="checkbox" class="criterion-cb" checked data-id="8" onclick="event.stopPropagation()">
          <span class="num">8</span>
          <span class="title" onclick="toggleCriterion(this.closest('.criterion-item'))">è´§å¸èµ„é‡‘ > æœ‰æ¯è´Ÿå€ºæ€»å’Œ</span>
          <span class="arrow" onclick="toggleCriterion(this.closest('.criterion-item'))">&#9660;</span>
        </div>
        <div class="criterion-detail"><div class="criterion-detail-inner">
          <span class="logic-label">è®¡ç®—å…¬å¼</span>
          <div class="logic-formula">æœ‰æ¯è´Ÿå€º = çŸ­æœŸå€Ÿæ¬¾ + é•¿æœŸå€Ÿæ¬¾ + åº”ä»˜å€ºåˆ¸ + ä¸€å¹´å†…åˆ°æœŸéæµåŠ¨è´Ÿå€º
è¦æ±‚ï¼šè´§å¸èµ„é‡‘ > æœ‰æ¯è´Ÿå€º</div>
          <span class="logic-label">è´¨æŠ¼æ£€æŸ¥</span>
          <div class="logic-formula">æŸ¥ STK_HOLDER_PLEDGE è¡¨ï¼Œå–æœ€æ–°è´¨æŠ¼æ¯”ä¾‹(pledge_ratio)
è´¨æŠ¼æ¯”ä¾‹ > 30% â†’ ç›´æ¥æ’é™¤ï¼ˆé£é™©è¿‡é«˜ï¼‰</div>
          <span class="logic-label">æ•°æ®æ¥æº</span>
          èµ„äº§è´Ÿå€ºè¡¨æœ€æ–°ä¸€æœŸï¼ˆcash_equivalents / shortterm_loan / longterm_loan / bonds_payable / non_current_liability_in_one_yearï¼‰
          <div class="note">* å‰ä¸€ç‰ˆç¼ºå°‘"ä¸€å¹´å†…åˆ°æœŸéæµåŠ¨è´Ÿå€º"ï¼Œå·²ä¿®æ­£è¡¥å……</div>
        </div></div>
      </div>

    </div>
    <button class="btn btn-primary" id="btnStart" onclick="startScreening()">å¼€å§‹ç­›é€‰</button>
    <div class="progress-wrap" id="progressWrap">
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      <div class="progress-text" id="progressText">æ­£åœ¨åˆå§‹åŒ–...</div>
    </div>
  </section>

  <!-- ç­›é€‰ç»“æœ -->
  <section class="panel results" id="resultsPanel">
    <div class="panel-title">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
      ç­›é€‰ç»“æœ
    </div>
    <div class="summary-row" id="summaryRow"></div>
    <div class="stages" id="stagesDiv"></div>
    <div class="stock-grid" id="stockGrid"></div>
  </section>
</main>

<!-- è¯¦æƒ…å¼¹çª— -->
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <div class="modal-header" id="modalHeader">
      <div>
        <h2 id="modalTitle">--</h2>
        <span class="sector-tag" id="modalSector">--</span>
      </div>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="tabs">
      <button class="tab-btn active" data-tab="chart" onclick="switchTab('chart')">è¡Œæƒ…èµ°åŠ¿</button>
      <button class="tab-btn" data-tab="financials" onclick="switchTab('financials')">è´¢åŠ¡æ•°æ®</button>
      <button class="tab-btn" data-tab="shareholders" onclick="switchTab('shareholders')">è‚¡ä¸œä¿¡æ¯</button>
      <button class="tab-btn" data-tab="dividend" onclick="switchTab('dividend')">åˆ†çº¢è®°å½•</button>
    </div>

    <!-- è¡Œæƒ…èµ°åŠ¿ -->
    <div class="tab-pane active" id="pane-chart">
      <div class="chart-box" id="klineChart"></div>
    </div>

    <!-- è´¢åŠ¡æ•°æ® -->
    <div class="tab-pane" id="pane-financials">
      <div class="growth-charts">
        <div class="growth-chart-box" id="revenueGrowthChart"></div>
        <div class="growth-chart-box" id="profitGrowthChart"></div>
      </div>
      <div id="financialTables">
        <div class="loading"><div class="spinner"></div>åŠ è½½ä¸­...</div>
      </div>
    </div>

    <!-- è‚¡ä¸œä¿¡æ¯ -->
    <div class="tab-pane" id="pane-shareholders">
      <div id="shareholderContent">
        <div class="loading"><div class="spinner"></div>åŠ è½½ä¸­...</div>
      </div>
    </div>

    <!-- åˆ†çº¢è®°å½• -->
    <div class="tab-pane" id="pane-dividend">
      <div class="div-chart-box" id="dividendChart"></div>
      <div id="dividendTable"></div>
    </div>
  </div>
</div>

<footer class="footer">
  æ•°æ®æ¥æºï¼šTushare Pro | ä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®
</footer>

<script>
/* ===== æ¡ä»¶å±•å¼€/æ”¶èµ· ===== */
function toggleCriterion(el) {
  el.classList.toggle('open');
}

/* ===== å…¨é€‰/å…¨ä¸é€‰ ===== */
function selectAll(checked) {
  document.querySelectorAll('.criterion-cb').forEach(cb => { cb.checked = checked; });
}

function getSelectedCriteria() {
  const selected = [];
  document.querySelectorAll('.criterion-cb:checked').forEach(cb => {
    selected.push(parseInt(cb.dataset.id));
  });
  return selected;
}

/* ===== å…¨å±€çŠ¶æ€ ===== */
let currentCode = null;
let chartInstances = {};
let screenResults = null;

/* ===== ç­›é€‰æ§åˆ¶ ===== */
async function startScreening() {
  const selected = getSelectedCriteria();
  if (selected.length === 0) {
    alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç­›é€‰æ¡ä»¶');
    return;
  }
  const btn = document.getElementById('btnStart');
  btn.disabled = true;
  btn.textContent = 'ç­›é€‰ä¸­...';
  document.getElementById('progressWrap').classList.add('active');
  document.getElementById('resultsPanel').classList.remove('active');

  try {
    await fetch('/api/screen/start', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ criteria: selected })
    });
    pollProgress();
  } catch (e) {
    alert('å¯åŠ¨ç­›é€‰å¤±è´¥: ' + e.message);
    resetBtn();
  }
}

function pollProgress() {
  fetch('/api/screen/progress')
    .then(r => r.json())
    .then(data => {
      const p = data.progress || {};
      document.getElementById('progressText').textContent = p.message || 'å¤„ç†ä¸­...';
      // æ¨¡æ‹Ÿè¿›åº¦
      const fill = document.getElementById('progressFill');
      const curr = parseFloat(fill.style.width) || 5;
      fill.style.width = Math.min(curr + 2, 95) + '%';

      if (data.error) {
        document.getElementById('progressText').textContent = 'ç­›é€‰å‡ºé”™: ' + data.error;
        resetBtn();
        return;
      }
      if (data.is_running) {
        setTimeout(pollProgress, 1500);
      } else {
        fill.style.width = '100%';
        fetchResults();
      }
    })
    .catch(() => setTimeout(pollProgress, 2000));
}

function fetchResults() {
  fetch('/api/screen/results')
    .then(r => r.json())
    .then(data => {
      if (data.error) {
        document.getElementById('progressText').textContent = data.error;
        resetBtn();
        return;
      }
      screenResults = data;
      showResults(data);
      resetBtn();
    })
    .catch(e => {
      document.getElementById('progressText').textContent = 'è·å–ç»“æœå¤±è´¥';
      resetBtn();
    });
}

function resetBtn() {
  const btn = document.getElementById('btnStart');
  btn.disabled = false;
  btn.textContent = 'é‡æ–°ç­›é€‰';
  setTimeout(() => {
    document.getElementById('progressWrap').classList.remove('active');
  }, 1000);
}

/* ===== å±•ç¤ºç»“æœ ===== */
function showResults(data) {
  document.getElementById('resultsPanel').classList.add('active');

  // æ•°æ®æ—¥æœŸä¿¡æ¯
  let dateInfoHtml = '';
  if (data.data_dates) {
    const dd = data.data_dates;
    dateInfoHtml = '<div style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); border-left: 4px solid var(--green); padding: 0.7rem 1rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.8rem;">';
    dateInfoHtml += '<div style="font-weight: 600; color: var(--text); margin-bottom: 0.4rem; display: flex; align-items: center; gap: 0.5rem;">';
    dateInfoHtml += '<span style="font-size: 1rem;">ğŸ“…</span><span>æ•°æ®æ—¶é—´</span></div>';
    dateInfoHtml += '<div style="color: var(--text2); line-height: 1.8; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.3rem;">';
    if (dd.screening_time) {
      dateInfoHtml += `<div>ğŸ” ç­›é€‰æ—¶é—´: <strong style="color: var(--text);">${dd.screening_time}</strong></div>`;
    }
    if (dd.stock_list_update) {
      dateInfoHtml += `<div>ğŸ“Š è‚¡ç¥¨åˆ—è¡¨: <strong style="color: var(--text);">${dd.stock_list_update}</strong></div>`;
    }
    if (dd.latest_financial_report) {
      dateInfoHtml += `<div>ğŸ’° æœ€æ–°è´¢æŠ¥: <strong style="color: var(--text);">${dd.latest_financial_report}</strong></div>`;
    }
    if (dd.price_data_update) {
      dateInfoHtml += `<div>ğŸ’¹ è¡Œæƒ…æ›´æ–°: <strong style="color: var(--text);">${dd.price_data_update}</strong></div>`;
    }
    dateInfoHtml += '</div></div>';
  }

  // æ‘˜è¦ç»Ÿè®¡å¡ç‰‡
  const pct = data.total_initial > 0 ? ((data.final_count / data.total_initial) * 100).toFixed(2) : 0;
  const summaryCards = `
    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
      <div class="stat-card"><div class="val">${data.total_initial}</div><div class="lbl">åˆå§‹è‚¡ç¥¨æ•°</div></div>
      <div class="stat-card"><div class="val" style="color:var(--green)">${data.final_count}</div><div class="lbl">ç¬¦åˆæ¡ä»¶</div></div>
      <div class="stat-card"><div class="val" style="color:var(--blue)">${pct}%</div><div class="lbl">é€šè¿‡ç‡</div></div>
    </div>
  `;

  document.getElementById('summaryRow').innerHTML = dateInfoHtml + summaryCards;

  // ç­›é€‰è¿‡ç¨‹
  let stHtml = '';
  (data.stages || []).forEach(s => {
    stHtml += `<div class="stage-row">
      <span class="name">${s.criterion}</span>
      <span class="nums">${s.before} &rarr; ${s.after} <span class="elim">(-${s.eliminated})</span></span>
    </div>`;
  });
  document.getElementById('stagesDiv').innerHTML = stHtml;

  // è‚¡ç¥¨å¡ç‰‡
  let gridHtml = '';
  const names = data.stock_names || {};
  (data.passed || []).forEach(code => {
    const name = names[code] || '--';
    gridHtml += `<div class="stock-card" onclick="openDetail('${code}')">
      <div class="code">${code}</div>
      <div class="name">${name}</div>
    </div>`;
  });
  if (!data.passed || data.passed.length === 0) {
    gridHtml = '<div style="text-align:center;padding:2rem;color:var(--text2);grid-column:1/-1;">æš‚æ— ç¬¦åˆå…¨éƒ¨æ¡ä»¶çš„è‚¡ç¥¨ï¼Œæ‚¨å¯ä»¥å°è¯•æ”¾å®½éƒ¨åˆ†æ¡ä»¶</div>';
  }
  document.getElementById('stockGrid').innerHTML = gridHtml;
}

/* ===== è¯¦æƒ…å¼¹çª— ===== */
function openDetail(code) {
  currentCode = code;
  document.getElementById('modalOverlay').classList.add('active');
  document.body.style.overflow = 'hidden';

  // è®¾ç½®æ ‡é¢˜
  const names = screenResults?.stock_names || {};
  document.getElementById('modalTitle').textContent = `${code} ${names[code] || ''}`;

  // æ¸…ç©ºä¹‹å‰å†…å®¹
  destroyCharts();
  document.getElementById('financialTables').innerHTML = '<div class="loading"><div class="spinner"></div>åŠ è½½ä¸­...</div>';
  document.getElementById('shareholderContent').innerHTML = '<div class="loading"><div class="spinner"></div>åŠ è½½ä¸­...</div>';
  document.getElementById('dividendTable').innerHTML = '';

  // åˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªtab
  switchTab('chart');

  // å¹¶è¡ŒåŠ è½½æ•°æ®
  loadSectorInfo(code);
  loadKline(code);
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('active');
  document.body.style.overflow = '';
  destroyCharts();
  currentCode = null;
}

function destroyCharts() {
  Object.values(chartInstances).forEach(c => { try { c.dispose(); } catch(e) {} });
  chartInstances = {};
}

function switchTab(tabId) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tabId));
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.toggle('active', p.id === 'pane-' + tabId));

  // æ‡’åŠ è½½æ•°æ®
  if (tabId === 'chart' && currentCode) {
    setTimeout(() => { if (chartInstances.kline) chartInstances.kline.resize(); }, 100);
  }
  if (tabId === 'financials' && currentCode) loadFinancials(currentCode);
  if (tabId === 'shareholders' && currentCode) loadShareholders(currentCode);
  if (tabId === 'dividend' && currentCode) loadDividend(currentCode);
}

/* ===== æ•°æ®åŠ è½½ ===== */
async function loadSectorInfo(code) {
  try {
    const r = await fetch(`/api/stock/${code}/sector`);
    const d = await r.json();
    document.getElementById('modalSector').textContent = d.industry || 'æœªçŸ¥è¡Œä¸š';
  } catch (e) {
    document.getElementById('modalSector').textContent = '--';
  }
}

async function loadKline(code) {
  const container = document.getElementById('klineChart');
  container.innerHTML = '<div class="loading"><div class="spinner"></div>åŠ è½½Kçº¿æ•°æ®...</div>';
  try {
    const r = await fetch(`/api/stock/${code}/kline?start=20200101`);
    const data = await r.json();
    if (!data.dates || data.dates.length === 0) {
      container.innerHTML = '<div class="loading">æš‚æ— è¡Œæƒ…æ•°æ®</div>';
      return;
    }
    container.innerHTML = '';
    renderKline(container, data);
  } catch (e) {
    container.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥</div>';
  }
}

async function loadFinancials(code) {
  const tablesDiv = document.getElementById('financialTables');
  // é¿å…é‡å¤åŠ è½½
  if (tablesDiv.dataset.loaded === code) return;
  tablesDiv.innerHTML = '<div class="loading"><div class="spinner"></div>åŠ è½½è´¢åŠ¡æ•°æ®...</div>';

  try {
    const r = await fetch(`/api/stock/${code}/financials`);
    const data = await r.json();
    tablesDiv.dataset.loaded = code;

    // ç»˜åˆ¶å¢é•¿è¶‹åŠ¿å›¾
    renderGrowthCharts(data.profit || []);

    let html = '';

    // åˆ©æ¶¦è¡¨
    if (data.profit && data.profit.length > 0) {
      html += buildFinTable('åˆ©æ¶¦è¡¨', data.profit, [
        'æŠ¥å‘Šæ—¥', 'è¥ä¸šæ€»æ”¶å…¥', 'è¥ä¸šæ€»æˆæœ¬', 'è¥ä¸šåˆ©æ¶¦', 'åˆ©æ¶¦æ€»é¢', 'å‡€åˆ©æ¶¦'
      ]);
    }

    // èµ„äº§è´Ÿå€ºè¡¨
    if (data.balance && data.balance.length > 0) {
      html += buildFinTable('èµ„äº§è´Ÿå€ºè¡¨', data.balance, [
        'æŠ¥å‘Šæ—¥', 'è´§å¸èµ„é‡‘', 'åº”æ”¶è´¦æ¬¾', 'å­˜è´§', 'æ€»èµ„äº§',
        'çŸ­æœŸå€Ÿæ¬¾', 'é•¿æœŸå€Ÿæ¬¾', 'åº”ä»˜å€ºåˆ¸', 'æ€»è´Ÿå€º', 'è‚¡ä¸œæƒç›Šåˆè®¡'
      ]);
    }

    // ç°é‡‘æµé‡è¡¨
    if (data.cashflow && data.cashflow.length > 0) {
      html += buildFinTable('ç°é‡‘æµé‡è¡¨', data.cashflow, [
        'æŠ¥å‘Šæ—¥', 'ç»è¥æ´»åŠ¨äº§ç”Ÿçš„ç°é‡‘æµé‡å‡€é¢', 'æŠ•èµ„æ´»åŠ¨äº§ç”Ÿçš„ç°é‡‘æµé‡å‡€é¢',
        'ç­¹èµ„æ´»åŠ¨äº§ç”Ÿçš„ç°é‡‘æµé‡å‡€é¢', 'ç°é‡‘åŠç°é‡‘ç­‰ä»·ç‰©å‡€å¢åŠ é¢'
      ]);
    }

    tablesDiv.innerHTML = html || '<div class="loading">æš‚æ— è´¢åŠ¡æ•°æ®</div>';
  } catch (e) {
    tablesDiv.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥</div>';
  }
}

function buildFinTable(title, rows, fields) {
  // æ‰¾å‡ºå®é™…å­˜åœ¨çš„å­—æ®µ
  const existing = fields.filter(f => rows.some(r => r[f] !== undefined && r[f] !== null));
  if (existing.length === 0) return '';

  let html = `<div class="fin-section"><h3>${title}</h3><div class="table-wrap"><table class="fin-table"><thead><tr>`;
  existing.forEach(f => { html += `<th>${f === 'æŠ¥å‘Šæ—¥' ? 'æŠ¥å‘ŠæœŸ' : f}</th>`; });
  html += '</tr></thead><tbody>';

  rows.forEach(row => {
    html += '<tr>';
    existing.forEach(f => {
      let val = row[f];
      if (f === 'æŠ¥å‘Šæ—¥') {
        html += `<td>${String(val || '').substring(0, 10)}</td>`;
      } else {
        val = parseFloat(val) || 0;
        html += `<td>${formatNum(val)}</td>`;
      }
    });
    html += '</tr>';
  });

  html += '</tbody></table></div></div>';
  return html;
}

function formatNum(n) {
  if (Math.abs(n) >= 1e8) return (n / 1e8).toFixed(2) + 'äº¿';
  if (Math.abs(n) >= 1e4) return (n / 1e4).toFixed(2) + 'ä¸‡';
  return n.toFixed(2);
}

async function loadShareholders(code) {
  const div = document.getElementById('shareholderContent');
  if (div.dataset.loaded === code) return;
  div.innerHTML = '<div class="loading"><div class="spinner"></div>åŠ è½½è‚¡ä¸œæ•°æ®...</div>';

  try {
    const r = await fetch(`/api/stock/${code}/shareholders`);
    const data = await r.json();
    div.dataset.loaded = code;

    if (!data || data.length === 0) {
      div.innerHTML = '<div class="loading">æš‚æ— è‚¡ä¸œæ•°æ®</div>';
      return;
    }

    // è·å–æ˜¾ç¤ºç”¨çš„åˆ—
    const cols = Object.keys(data[0]).filter(k => !k.startsWith('_'));
    let html = '<div class="table-wrap"><table class="sh-table"><thead><tr>';
    cols.forEach(c => { html += `<th>${c}</th>`; });
    html += '</tr></thead><tbody>';

    data.forEach(row => {
      html += '<tr>';
      cols.forEach(c => {
        const val = String(row[c] || '');
        const isSoe = c.includes('è‚¡ä¸œ') && isSoeText(val);
        html += `<td class="${isSoe ? 'sh-soe' : ''}">${val}</td>`;
      });
      html += '</tr>';
    });
    html += '</tbody></table></div>';
    div.innerHTML = html;
  } catch (e) {
    div.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥</div>';
  }
}

function isSoeText(text) {
  const kws = ['å›½æœ‰', 'å›½èµ„', 'è´¢æ”¿', 'å›½æŠ•', 'ä¸­å¤®', 'æ”¿åºœ', 'å›½å®¶'];
  return kws.some(k => text.includes(k));
}

async function loadDividend(code) {
  const chartDiv = document.getElementById('dividendChart');
  const tableDiv = document.getElementById('dividendTable');
  if (tableDiv.dataset.loaded === code) return;
  chartDiv.innerHTML = '';
  tableDiv.innerHTML = '<div class="loading"><div class="spinner"></div>åŠ è½½åˆ†çº¢æ•°æ®...</div>';

  try {
    const r = await fetch(`/api/stock/${code}/dividend`);
    const data = await r.json();
    tableDiv.dataset.loaded = code;

    if (!data || data.length === 0) {
      tableDiv.innerHTML = '<div class="loading">æš‚æ— åˆ†çº¢æ•°æ®</div>';
      return;
    }

    // ç»˜åˆ¶åˆ†çº¢å›¾
    renderDividendChart(chartDiv, data);

    // è¡¨æ ¼
    const cols = Object.keys(data[0]).filter(k => !k.startsWith('_'));
    let html = '<div class="table-wrap"><table class="fin-table"><thead><tr>';
    cols.forEach(c => { html += `<th>${c}</th>`; });
    html += '</tr></thead><tbody>';
    data.forEach(row => {
      html += '<tr>';
      cols.forEach(c => { html += `<td>${row[c] ?? ''}</td>`; });
      html += '</tr>';
    });
    html += '</tbody></table></div>';
    tableDiv.innerHTML = html;
  } catch (e) {
    tableDiv.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥</div>';
  }
}

/* ===== ECharts æ¸²æŸ“ ===== */
function renderKline(container, data) {
  const chart = echarts.init(container);
  chartInstances.kline = chart;

  const upColor = '#e63946';
  const downColor = '#00b894';

  chart.setOption({
    animation: false,
    tooltip: {
      trigger: 'axis',
      axisPointer: { type: 'cross' },
      formatter: params => {
        const k = params.find(p => p.seriesName === 'Kçº¿');
        if (!k) return '';
        const d = k.data;
        return `<b>${params[0].axisValue}</b><br/>
          å¼€ç›˜: ${d[1]}<br/>æ”¶ç›˜: ${d[2]}<br/>
          æœ€ä½: ${d[3]}<br/>æœ€é«˜: ${d[4]}`;
      }
    },
    grid: [
      { left: '12%', right: '5%', top: '5%', height: '55%' },
      { left: '12%', right: '5%', top: '68%', height: '18%' }
    ],
    xAxis: [
      { type: 'category', data: data.dates, boundaryGap: false, axisLine: { onZero: false }, splitLine: { show: false }, min: 'dataMin', max: 'dataMax' },
      { type: 'category', gridIndex: 1, data: data.dates, boundaryGap: false, axisTick: { show: false }, splitLine: { show: false }, axisLabel: { show: false }, min: 'dataMin', max: 'dataMax' }
    ],
    yAxis: [
      { scale: true, splitArea: { show: true } },
      { scale: true, gridIndex: 1, splitNumber: 2, axisLabel: { show: false }, axisLine: { show: false }, axisTick: { show: false }, splitLine: { show: false } }
    ],
    dataZoom: [
      { type: 'inside', xAxisIndex: [0, 1], start: 70, end: 100 },
      { show: true, xAxisIndex: [0, 1], type: 'slider', top: '90%', start: 70, end: 100, height: 20 }
    ],
    series: [
      {
        name: 'Kçº¿',
        type: 'candlestick',
        data: data.ohlc,
        itemStyle: { color: upColor, color0: downColor, borderColor: upColor, borderColor0: downColor }
      },
      {
        name: 'æˆäº¤é‡',
        type: 'bar',
        xAxisIndex: 1,
        yAxisIndex: 1,
        data: data.volumes.map((v, i) => ({
          value: v,
          itemStyle: { color: data.ohlc[i][1] >= data.ohlc[i][0] ? upColor : downColor }
        }))
      }
    ]
  });

  window.addEventListener('resize', () => chart.resize());
}

function renderGrowthCharts(profitData) {
  if (!profitData || profitData.length < 2) return;

  const years = profitData.map(r => String(r['æŠ¥å‘Šæ—¥'] || '').substring(0, 4)).reverse();
  const revenues = profitData.map(r => parseFloat(r['è¥ä¸šæ€»æ”¶å…¥']) || 0).reverse();
  const profits = profitData.map(r => parseFloat(r['å‡€åˆ©æ¶¦']) || 0).reverse();

  // è¥æ”¶å›¾
  const revContainer = document.getElementById('revenueGrowthChart');
  if (revContainer) {
    const c1 = echarts.init(revContainer);
    chartInstances.revGrowth = c1;
    c1.setOption({
      title: { text: 'è¥ä¸šæ€»æ”¶å…¥è¶‹åŠ¿', textStyle: { fontSize: 13 }, left: 'center' },
      tooltip: { trigger: 'axis', formatter: p => p[0].axisValue + ': ' + formatNum(p[0].value) },
      xAxis: { type: 'category', data: years },
      yAxis: { type: 'value', axisLabel: { formatter: v => formatNum(v) } },
      series: [{ type: 'bar', data: revenues, itemStyle: { color: '#457b9d' }, barWidth: '50%' }],
      grid: { left: '15%', right: '5%', bottom: '10%', top: '18%' }
    });
  }

  // å‡€åˆ©æ¶¦å›¾
  const profContainer = document.getElementById('profitGrowthChart');
  if (profContainer) {
    const c2 = echarts.init(profContainer);
    chartInstances.profGrowth = c2;
    c2.setOption({
      title: { text: 'å‡€åˆ©æ¶¦è¶‹åŠ¿', textStyle: { fontSize: 13 }, left: 'center' },
      tooltip: { trigger: 'axis', formatter: p => p[0].axisValue + ': ' + formatNum(p[0].value) },
      xAxis: { type: 'category', data: years },
      yAxis: { type: 'value', axisLabel: { formatter: v => formatNum(v) } },
      series: [{ type: 'bar', data: profits, itemStyle: { color: '#e63946' }, barWidth: '50%' }],
      grid: { left: '15%', right: '5%', bottom: '10%', top: '18%' }
    });
  }
}

function renderDividendChart(container, data) {
  if (!data || data.length === 0) return;

  const years = data.map(r => String(r['æŠ¥å‘ŠæœŸ'] || '').substring(0, 4)).reverse();
  const cashDiv = data.map(r => {
    let v = parseFloat(r['ç°é‡‘åˆ†çº¢-æ¯è‚¡æ´¾æ¯'] || r['ç°é‡‘åˆ†çº¢-ç°é‡‘åˆ†çº¢æ¯”ä¾‹'] || 0);
    return v;
  }).reverse();

  const chart = echarts.init(container);
  chartInstances.dividend = chart;
  chart.setOption({
    title: { text: 'å†å¹´åˆ†çº¢', textStyle: { fontSize: 13 }, left: 'center' },
    tooltip: { trigger: 'axis' },
    xAxis: { type: 'category', data: years },
    yAxis: { type: 'value', name: 'æ¯10è‚¡æ´¾æ¯(å…ƒ)' },
    series: [{
      type: 'bar',
      data: cashDiv,
      itemStyle: { color: '#2a9d8f' },
      barWidth: '50%'
    }],
    grid: { left: '12%', right: '5%', bottom: '10%', top: '18%' }
  });
}

/* ===== é¡µé¢åˆå§‹åŒ– ===== */
document.addEventListener('DOMContentLoaded', () => {
  // æ£€æŸ¥æ˜¯å¦æœ‰å·²æœ‰ç»“æœ
  fetch('/api/screen/results')
    .then(r => { if (r.ok) return r.json(); throw new Error(); })
    .then(data => {
      if (data && data.passed) {
        screenResults = data;
        showResults(data);
      }
    })
    .catch(() => {});

  // å…¨å±€ resize
  window.addEventListener('resize', () => {
    Object.values(chartInstances).forEach(c => { try { c.resize(); } catch(e) {} });
  });
});
</script>
</body>
</html>
